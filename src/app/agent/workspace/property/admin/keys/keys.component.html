<ion-content id="property-keys">
  <mat-accordion multi class="form-table-view-accordian">
    <mat-expansion-panel #propertyKeys hideToggle expanded>
      <mat-expansion-panel-header>
        <mat-panel-title>
          Keys
        </mat-panel-title>
        <mat-panel-description class="ion-justify-content-end no-margin">
          <div>
            <span *ngIf="!propertyKeys.expanded" class="accordian-icon" title="Expand">
              <ion-icon style="pointer-events:none;" name="add-circle"></ion-icon>
            </span>
            <span *ngIf="propertyKeys.expanded" class="accordian-icon" title="Collapse">
              <ion-icon style="pointer-events:none;" name="remove-circle"></ion-icon>
            </span>
          </div>
        </mat-panel-description>
      </mat-expansion-panel-header>
      <ion-grid class="common-field-block">
        <ion-row>
          <ion-col size="60" class="ion-align-self-end">
            <ion-button color="success">Add</ion-button>
          </ion-col>
          <ion-col size="20">
            <ion-item>
              <ion-label position="floating">Key Code</ion-label>
              <ion-input [formControl]="keyCode" readonly></ion-input>
            </ion-item>
          </ion-col>
          <ion-col size="20">
            <ion-item>
              <ion-label position="floating">Alarm Code</ion-label>
              <ion-input [formControl]="alarmCode" readonly></ion-input>
            </ion-item>
          </ion-col>          
        </ion-row>
      </ion-grid>

      <form [formGroup]="propertyKeySetForm">
        <ion-grid class="ion-no-padding">
          <ion-row class="ion-justify-content-start" formArrayName="propertyKeySets">
            <ion-col size="100" *ngIf="propertyKeySetForm.get('propertyKeySets')['controls'].length === 0" class="no-record-msg">
              <ion-text>{{DEFAULT_MESSAGES.NO_RECORD_FOUND}}</ion-text>
            </ion-col>
            <ion-col size-xl="33.3" size-lg="33.3" size-md="50" size-sm="50" size-xs="100" class="property-card-set ion-no-padding"
              *ngFor="let item of propertyKeySetForm.get('propertyKeySets')['controls']; let i=index">
              <ion-card [formGroupName]="i">
                <ion-card-content class="ion-no-padding">
                  <div class="header"
                    [ngClass]="{'warning' : item.controls.status.value === 0, 'success' : item.controls.status.value === 1, 'danger' : item.controls.status.value === 2}">
                    <ion-grid>
                      <ion-row>
                        <ion-col size="80" class="ion-align-self-center">
                          <ion-text>{{item.controls.status.value | lookup: keyStatuses || notAvailable}}</ion-text>
                        </ion-col>
                        <ion-col size="10" matTooltip="History" matTooltipPosition="above"
                          (click)="onHistoryClick(item.value)">
                          <i class="propcoicon propcoicon-log-history pointer"></i>
                        </ion-col>
                        <ion-col size="10" matTooltip="Remove" matTooltipPosition="above">
                          <i class="propcoicon propcoicon-cancel pointer"></i>
                        </ion-col>
                      </ion-row>
                    </ion-grid>
                  </div>
                  <div class="content">
                    <ion-grid>
                      <ion-row>
                        <ion-col>
                          <h1>{{item.controls.name.value || notAvailable}}</h1>
                        </ion-col>
                        <ion-col size="100">
                          <ion-item>
                            <ion-label position="floating">key ID</ion-label>
                            <ion-input formControlName="keyId"></ion-input>
                          </ion-item>
                        </ion-col>
                        <ion-col size="100">
                          <ion-item>
                            <ion-label position="floating">Key Type</ion-label>
                            <ion-input formControlName="type"></ion-input>
                          </ion-item>
                        </ion-col>
                        <ion-col size="50" style="padding-right: 10px;">
                          <mat-form-field appearance="fill" style="margin-top: 11px;">
                            <mat-label> Setup date </mat-label>
                            <input matInput [matDatepicker]="picker" formControlName="createdAt" readonly>
                            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                            <mat-datepicker #picker></mat-datepicker>
                          </mat-form-field>
                        </ion-col>
                        <ion-col size="50">
                          <ion-item>
                            <ion-label position="floating">Setup By</ion-label>
                            <ion-select interface="popover" formControlName="userId">
                              <ion-select-option [value]="item.userId" *ngFor="let item of userDetailsList">
                                {{ item?.forename }} {{ item?.surname }}
                              </ion-select-option>
                            </ion-select>
                          </ion-item>
                        </ion-col>
                        <ion-col size="100">
                          <ion-item>
                            <ion-label position="floating">Comments</ion-label>
                            <ion-input formControlName="note"></ion-input>
                          </ion-item>
                        </ion-col>
                      </ion-row>
                    </ion-grid>
                  </div>
                  <div class="footer">
                    <ion-grid>
                      <ion-row>
                        <ion-col size="50">
                          <ion-button color="success" (click)="addKeysetLogHistory(item.value)">
                            {{item.controls.status.value === 0?"Check
                            In":item.controls.status.value === 1?"Check
                            Out":"Check
                            In"}}</ion-button>
                        </ion-col>
                        <ion-col size="50" class="ion-text-right">
                          <ion-button color="success">Update</ion-button>
                        </ion-col>
                      </ion-row>
                    </ion-grid>
                  </div>
                </ion-card-content>
              </ion-card>
            </ion-col>
          </ion-row>
        </ion-grid>
      </form>

      <h5 style="padding: 5px 10px;">Log History</h5>
      <div class="overlay-container" style="position: relative;">
        <table datatable [dtOptions]="historyDtOption" [dtTrigger]="historyDtTrigger" class="row-border hover"
          width="100%" style="position: relative;">
          <thead>
            <tr>
              <th style="width:15%;">Date</th>
              <th style="width:20%;">User</th>
              <th style="width:15%;">Type</th>
              <th style="width:20%;">Person</th>
              <th>Comments</th>
              <th style="width:38px;"></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of logHistoryList" class="table-row">
              <td>{{item.postDate | date: DATE_FORMAT.DATE || notAvailable}}</td>
              <td>{{item.userName || notAvailable}}</td>
              <td>{{item.activityDescription || notAvailable}}</td>
              <td>{{item.name || notAvailable}}</td>
              <td>{{item.note || notAvailable}}</td>
              <td class="resp-action-icon">
                <i (click)="showMenu($event,'divOverlay', item, 'table-row')"
                  class="propcoicon propcoicon-actions-on action-btn"></i>
              </td>
            </tr>
          </tbody>
        </table>
        <div id="divOverlay">
          <ion-button (click)="editKeysetLogHistory()"> Edit </ion-button>
          <i (click)="hideMenu($event,'divOverlay')" class="propcoicon propcoicon-actions-on"></i>
        </div>
      </div>

      <h5 style="padding: 0px 10px;">Notes</h5>
      <ion-grid class="common-field-block">
        <ion-row>
          <ion-col size="100">
            <ion-item>
              <ion-label position="floating">Enter any keys related notes for this unit/property</ion-label>
              <ion-textarea rows="1" [formControl]="keysNotes" auto-grow="true"></ion-textarea>
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-grid>
    </mat-expansion-panel>
  </mat-accordion>
</ion-content>